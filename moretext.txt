<template>
  <div id="activity">
    <el-form ref="form" :model="form" size="small">
      <el-form-item label="时间：">
        <el-date-picker
          v-model="form.time"
          type="daterange"
          range-separator="至"
          start-placeholder="开始日期"
          end-placeholder="结束日期"
          value-format="yyyy-MM-dd"
        ></el-date-picker>
        <span class="tip_label">状态：</span>
        <el-select v-model="form.status" placeholder="请选择需搜索的类型">
          <el-option label="全部" value></el-option>
          <el-option label="未开始" :value="0"></el-option>
          <el-option label="进行中" :value="1"></el-option>
          <el-option label="已过期" :value="2"></el-option>
        </el-select>
        <el-button size="small" type="primary" @click="getlist()">搜索</el-button>
        <el-button size="small" type="success" style="float:right" @click="visible=true">添加</el-button>
      </el-form-item>
    </el-form>
    <el-table :data="tableData" style="width: 100%" border size="small" v-loading="loading">
      <el-table-column type="index" label="序号"></el-table-column>
      <el-table-column prop="activity_title" label="活动标题"></el-table-column>
      <el-table-column prop="activity_type" label="类型">
        <template slot-scope="scope">
          <span v-if="scope.row.activity_type==1">图文</span>
          <span v-else-if="scope.row.activity_type==2">音频</span>
          <span v-else>视频</span>
        </template>
      </el-table-column>
      <el-table-column prop label="内容">
        <template slot-scope="scope">
          <div v-if="!scope.row.activity_content">
            <span>--</span>
          </div>
          <el-image
            v-else
            style="width: 100px; height: 100px"
            :src="scope.row.activity_content.img"
            fit="scale-down"
          ></el-image>
        </template>
      </el-table-column>
      <el-table-column prop="activity_start" label="活动时间">
        <template slot-scope="scope">
          <span>{{scope.row.activity_start}}/{{scope.row.activity_end}}</span>
        </template>
      </el-table-column>
      <el-table-column prop="shows" label="推送时间">
        <template slot-scope="scope">
          <span>{{scope.row.push_start}}/{{scope.row.push_end}}</span>
        </template>
      </el-table-column>
      <el-table-column prop="activity_status" label="状态">
        <template slot-scope="scope">
          <span v-if="scope.row.activity_status==0">未开始</span>
          <span v-else-if="scope.row.activity_status==1">进行中</span>
          <span v-else>已过期</span>
        </template>
      </el-table-column>
      <el-table-column prop="push_model_id" label="推送对象"></el-table-column>
      <el-table-column label="操作" fixed="right" width="300">
        <template slot-scope="scope">
          <el-button type="info" size="mini" @click="dets(scope.row)">详情</el-button>
          <el-button type="primary" size="mini" @click="toeditor(scope.row)">编辑</el-button>
          <el-button type="danger" size="mini" @click="removes(scope.row)">删除</el-button>
        </template>
      </el-table-column>
    </el-table>
    <div class="paginations">
      <el-pagination
        @current-change="handleCurrentChange"
        @size-change="handleSizeChange"
        :current-page.sync="theform.page"
        :page-sizes="[10, 30, 50, 100]"
        :page-size.sync="theform.perpage"
        layout="total, sizes,prev, pager, next, jumper"
        :total="total"
      ></el-pagination>
    </div>
    <!-- 新增 -->
    <el-dialog title :visible.sync="visible" width="50%">
      <el-form ref="addform" :model="addform" size="small" label-width="120px" :rules="rules">
        <el-form-item label="标题：" prop="activity_title">
          <el-input v-model="addform.activity_title" placeholder="请输入活动标题" maxlength="30"></el-input>
          <span class="form_tip">最多可输入30个字符</span>
        </el-form-item>
        <el-form-item label="类型：" prop="activity_type">
          <el-select v-model="addform.activity_type" placeholder="请选择">
            <el-option label="图文" :value="1"></el-option>
            <el-option label="音频" :value="2"></el-option>
            <el-option label="视频" :value="3"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="内容：">
          <div class="oth_cont_div" v-for="(v,i) in act_content" :key="i">
            <div class="int_span">
              <input
                type="file"
                class="el-button el-button--primary el-button--small"
                accept="image/*"
                id="cont_img"
                @change="events($event,i)"
              />
              <span class="form_tip">推荐图片分辨率782*420 如未上传会显示推送广告</span>
            </div>
            <img :src="v.img" alt @click="clickimg(v.img)" />
            <el-input
              type="textarea"
              v-model="v.text"
              placeholder="请输入活动文字，最多可输入200个字符"
              maxlength="200"
              show-word-limit
            ></el-input>
            <!-- <el-button
              type="primary"
              plain
              size="small"
              style="margin:0 12px"
              v-if="i==0"
              @click="addnews"
            >添加</el-button>
            <el-button
              type="warning"
              plain
              size="small"
              style="margin:0 12px"
              v-else
              @click="delnews(i)"
            >删除</el-button>-->
          </div>
        </el-form-item>
        <el-form-item label="活动时间：">
          <el-date-picker
            v-model="act_time"
            type="daterange"
            range-separator="至"
            start-placeholder="开始日期"
            end-placeholder="结束日期"
            value-format="yyyy-MM-dd"
          ></el-date-picker>
        </el-form-item>
        <el-form-item label="推送时间：">
          <el-date-picker
            v-model="put_time"
            type="daterange"
            range-separator="至"
            start-placeholder="开始日期"
            end-placeholder="结束日期"
            value-format="yyyy-MM-dd"
          ></el-date-picker>
        </el-form-item>
        <el-form-item label="推送对象：" prop="push_model_id">
          <span class="rules">按性别：</span>
          <el-radio-group v-model="addform.push_sex">
            <el-radio :label="0">所有</el-radio>
            <el-radio :label="1">男</el-radio>
            <el-radio :label="2">女</el-radio>
          </el-radio-group>
          <br />
          <span class="rules">按车型：</span>
          <el-checkbox-group v-model="addform.push_model_id" style="display:inline-block">
            <el-checkbox v-for="(v,i) in chatype" :key="i" :label="v.id">{{v.name}}</el-checkbox>
          </el-checkbox-group>
        </el-form-item>
        <el-form-item label="推送广告：">
          <div class="cont_div">
            <div class="int_span">
              <input
                type="file"
                class="el-button el-button--primary el-button--small"
                accept="image/*"
                id="cont_img"
                @change="putimg($event)"
              />
              <span class="form_tip">推荐图片分辨率782*420</span>
            </div>
            <img :src="pushimg" alt @click="clickimg(pushimg)" />
          </div>
        </el-form-item>
        <el-form-item label="推送频率：" prop="push_frequency">
          <el-select v-model="addform.push_frequency" placeholder="请选择">
            <el-option v-for="(v,i) in flying" :key="i" :label="v.name" :value="v.id"></el-option>
          </el-select>
        </el-form-item>
      </el-form>
      <span slot="footer" class="dialog-footer">
        <el-button @click="visible = false" size="small">取 消</el-button>
        <el-button type="primary" @click="toaddnew('addform')" size="small">发 布</el-button>
      </span>
    </el-dialog>
    <!-- //详情 -->
    <el-dialog title="详情" :visible.sync="detailvisible" width="30%">
      <div class="detait_div">
        <div class="other_div">
          <span>标题：</span>
          <span>{{det_data.activity_title}}</span>
        </div>
        <div class="other_div">
          <span>类型：</span>
          <span v-if="det_data.activity_type==1">图文</span>
          <span v-else-if="det_data.activity_type==2">音频</span>
          <span v-else>视频</span>
        </div>
        <div class="other_div">
          <span>内容：</span>
          <!-- <div v-for="(v,i) in det_data.activity_content" :key="i">
            <img :src="v.img" alt @click="clickimg(v.img)" />
            <span>{{v.text}}</span>
          </div>-->
          <div>
            <img
              :src="det_data.activity_content.img"
              @click="clickimg(det_data.activity_content.img)"
              alt
            />
            <span>{{det_data.activity_content.text}}</span>
          </div>
        </div>
        <div class="other_div">
          <span>活动时间：</span>
          <span>{{det_data.activity_start}}/{{det_data.activity_end}}</span>
        </div>
        <div class="other_div">
          <span>推送时间：</span>
          <span>{{det_data.push_start}}/{{det_data.push_end}}</span>
        </div>
        <div class="other_div">
          <span>推送对象：</span>
          <span>{{det_data.push_model_id}}</span>
        </div>
        <div class="other_div">
          <span>推送广告：</span>
          <img :src="det_data.push_ad_pic" alt @click="clickimg(det_data.push_ad_pic)" />
        </div>
        <div class="other_div">
          <span>推送频率：</span>
          <span v-if="det_data.push_frequency==1">每天推一次</span>
          <span v-else-if="det_data.push_frequency==2">每天推3次</span>
          <span v-else-if="det_data.push_frequency==3">联网即推</span>
          <span v-else>仅推一次</span>
        </div>
      </div>
    </el-dialog>
    <!-- 编辑 -->
    <el-dialog title :visible.sync="fixcolumn" width="50%">
      <el-form ref="editor" :model="editor" size="small" label-width="120px">
        <el-form-item label="标题：">
          <el-input v-model="editor.activity_title" placeholder="请输入活动标题" maxlength="30"></el-input>
          <span class="form_tip">最多可输入30个字符</span>
        </el-form-item>
        <el-form-item label="类型：">
          <el-select v-model="editor.activity_type" placeholder="请选择">
            <el-option label="图文" :value="1"></el-option>
            <el-option label="音频" :value="2"></el-option>
            <el-option label="视频" :value="3"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="内容：">
          <div class="oth_cont_div" v-for="(v,i) in editnews" :key="i">
            <div class="int_span">
              <input
                type="file"
                class="el-button el-button--primary el-button--small"
                accept="image/*"
                id="cont_img"
                @change="otherimg($event,i)"
              />
              <span class="form_tip">推荐图片分辨率782*420 如未上传会显示推送广告</span>
            </div>
            <img :src="v.img" alt @click="clickimg(v.img)" />
            <el-input
              type="textarea"
              v-model="v.text"
              placeholder="请输入活动文字，最多可输入200个字符"
              maxlength="200"
              show-word-limit
            ></el-input>
            <el-button
              size="small"
              type="primary"
              plain
              @click="ediimg"
              v-if="i==0"
              style="margin:0 12px"
            >添加</el-button>
            <el-button
              size="small"
              type="warning"
              plain
              @click="delimg(i)"
              v-else
              style="margin:0 12px"
            >删除</el-button>
          </div>
        </el-form-item>
        <el-form-item label="活动时间：">
          <el-date-picker
            v-model="det_act_time"
            type="daterange"
            range-separator="至"
            start-placeholder="开始日期"
            end-placeholder="结束日期"
            value-format="yyyy-MM-dd"
          ></el-date-picker>
        </el-form-item>
        <el-form-item label="推送时间：">
          <el-date-picker
            v-model="det_put_time"
            type="daterange"
            range-separator="至"
            start-placeholder="开始日期"
            end-placeholder="结束日期"
            value-format="yyyy-MM-dd"
          ></el-date-picker>
        </el-form-item>
        <el-form-item label="推送对象：">
          <span class="rules">按性别：</span>
          <el-radio-group v-model="editor.push_sex">
            <el-radio :label="0">所有</el-radio>
            <el-radio :label="1">男</el-radio>
            <el-radio :label="2">女</el-radio>
          </el-radio-group>
          <br />
          <span class="rules">按车型：</span>
          <el-checkbox-group v-model="editor.push_model_id" style="display:inline-block">
            <el-checkbox v-for="(v,i) in chatype" :key="i" :label="v.id">{{v.name}}</el-checkbox>
          </el-checkbox-group>
        </el-form-item>
        <el-form-item label="推送广告：">
          <div class="cont_div">
            <div class="int_span">
              <input
                type="file"
                class="el-button el-button--primary el-button--small"
                accept="image/*"
                id="cont_img"
                @change="edtimg($event)"
              />
              <span class="form_tip">推荐图片分辨率782*420</span>
            </div>
            <img :src="edt_pushimg" alt @click="clickimg(edt_pushimg)" />
          </div>
        </el-form-item>
        <el-form-item label="推送频率：">
          <el-select v-model="editor.push_frequency" placeholder="请选择">
            <el-option v-for="(v,i) in flying" :key="i" :label="v.name" :value="v.id"></el-option>
          </el-select>
        </el-form-item>
      </el-form>
      <span slot="footer" class="dialog-footer">
        <el-button @click="fixcolumn = false" size="small">取 消</el-button>
        <el-button type="primary" @click="sureeditore" size="small">发 布</el-button>
      </span>
    </el-dialog>
    <!-- 图片放大 -->
    <el-dialog :visible.sync="bigimg" width="40%">
      <el-image style="width: 100%; height: 100%" :src="click_url" fit="scale-down"></el-image>
    </el-dialog>
  </div>
</template>

<script>
export default {
  name: "deviceManage",
  data() {
    return {
      click_url: "",
      bigimg: false,
      editnews: [
        {
          img: "",
          text: ""
        }
      ],
      act_content: [
        {
          img: "",
          text: ""
        }
      ],
      theform: {
        page: 1,
        // perpage:10,
        username: this.defaultData.username,
        domain: this.defaultData.domain,
        login_token: this.defaultData.login_token
      },
      loading: false,
      editor: {
        push_model_id: [],
        push_frequency: "",
        activity_title: "",
        activity_type: "",
        push_sex: ""
      },
      fixcolumn: false,
      det_data: {
        activity_content: {}
      },
      detailvisible: false,
      rules: {
        activity_title: [
          { required: true, message: "请输入该字段", trigger: "blur" }
        ]
        // activity_content: [
        //   { required: true, message: "请输入该字段", trigger: "blur" }
        // ]
      },
      flying: [
        {
          name: "每天推一次",
          id: 1
        },
        {
          name: "每天推3次",
          id: 2
        },
        {
          name: "联网即推",
          id: 3
        },
        {
          name: "仅推一次",
          id: 4
        }
      ],
      chatype: [],
      det_act_time: [],
      det_put_time: [],
      act_time: [],
      put_time: [],
      pushimg: "",
      contentimg: "",
      edt_contentimg: "",
      edt_pushimg: "",
      addform: {
        push_model_id: [],
        activity_type: 1,
        push_sex: 0,
        push_frequency: 1
      },
      visible: false,
      form: {
        status: ""
      },
      tableData: [],
      total: 1,
      activity_id: ""
    };
  },
  created() {
    this.getlist();
    this.getcarbrand();
  },
  methods: {
    clickimg(e) {
      this.bigimg = true;
      this.click_url = e;
    },
    otherimg(e, index) {
      let data = new FormData(),
        url = this.api.uptoimg,
        name = e.target.files[0],
        cont = this.editnews,
        params = {};
      params = this.defaultData;
      params.image = name;
      for (let i in params) {
        data.append(i, params[i]);
      }
      this.$http.post(url, data).then(res => {
        let my = res.data;
        if (my.status == 1) {
          for (let i in cont) {
            if (i == index) {
              cont[i].img = my.data.image.full_path;
            }
          }
        } else {
          this.$message("上传失败");
        }
      });
    },
    ediimg() {
      this.editnews.push({
        text: "",
        img: ""
      });
    },
    delimg(e) {
      this.editnews.splice(e, 1);
    },
    events(e, index) {
      let data = new FormData(),
        url = this.api.uptoimg,
        name = e.target.files[0],
        cont = this.act_content,
        img = new Image(),
        src = window.URL.createObjectURL(name),
        $this = this,
        params = {};
      img.src = src;
      params = this.defaultData;
      params.image = name;
      img.onload = function() {
        if (img.width <= 782 && img.height <= 420) {
          for (let i in params) {
            data.append(i, params[i]);
          }
          $this.$http.post(url, data).then(res => {
            let my = res.data;
            if (my.status == 1) {
              for (let i in cont) {
                if (i == index) {
                  cont[i].img = my.data.image.full_path;
                }
              }
            } else {
              $this.$message("上传失败");
            }
          });
        } else {
          e.target.value = null;
          $this.$message("请上传符合条件的图片");
        }
      };
    },
    delnews(e) {
      this.act_content.splice(e, 1);
    },
    addnews() {
      this.act_content.push({
        text: "",
        img: ""
      });
    },
    getcarbrand() {
      let url = this.api.getcarbrand,
        params = {};
      params = this.defaultData;
      this.$http.get(url, { params: params }).then(res => {
        let my = res.data;
        if (my.status == 1) {
          let car = my.data.paris;
          for (let i in car) {
            this.chatype.push({
              name: car[i],
              id: i
            });
          }
        }
      });
    },
    getlist() {
      this.loading = true;
      let url = this.api.saleactivic,
        store = this.store,
        num = this.form,
        params = {};
      params = this.theform;
      params.status = num.status;
      if (num.time) {
        params.start_time = num.time[0];
        params.end_time = num.time[1];
      } else {
        params.start_time = null;
        params.end_time = null;
      }
      this.$http.get(url, { params: params }).then(res => {
        let my = res.data;
        if (my.status == 1) {
          this.tableData = my.data.list;
          this.total = my.data.total;
          this.loading = false;
        }
      });
    },
    handleCurrentChange() {
      this.getlist();
    },
    handleSizeChange() {
      this.getlist();
    },
    toaddnew(formName) {
      let url = this.api.toaddnewact,
        act_time = this.act_time,
        put_time = this.put_time,
        data = new FormData(),
        params = {},
        cont = this.act_content,
        par = this.addform;
      params = this.defaultData;
      params.action = "create";
      for (let i in par) {
        if (i == "push_model_id") {
          params["info[push_model_id]"] = par.push_model_id.join(",");
        } else {
          params[`info[${i}]`] = par[i];
        }
      }
      params["info[activity_start]"] = act_time[0];
      params["info[activity_end]"] = act_time[1];
      params["info[push_start]"] = put_time[0];
      params["info[push_end]"] = put_time[1];
      params["info[activity_content]"] = JSON.stringify(cont);
      params["info[push_ad_pic]"] = par.push_ad_pic;
      this.$refs[formName].validate(valid => {
        if (valid) {
          delete params.image; //删除params属性中的image
          // console.log(params);
          for (let i in params) {
            data.append(i, params[i]);
          }
          this.$http.post(url, data).then(res => {
            let my = res.data;
            if (my.status == 1) {
              this.$message({
                type: "success",
                message: "成功！"
              });
              window.location.reload();
              this.visible = false;
            } else {
              this.$message("失败");
            }
          });
        } else {
          console.log("error submit!!");
          return false;
        }
      });
    },
    putimg(e) {
      let name = e.target.files[0],
        src = window.URL.createObjectURL(name),
        url = this.api.uptoimg,
        img = new Image(),
        datas = new FormData(),
        $this = this,
        parm = {};
      parm = this.defaultData;
      parm.image = name;
      img.src = src;
      img.onload = function() {
        if (img.width <= 782 && img.height < 420) {
          $this.pushimg = src;
          for (let i in parm) {
            datas.append(i, parm[i]);
          }
          $this.$http.post(url, datas).then(res => {
            let my = res.data;
            if (my.status == 1) {
              $this.addform.push_ad_pic = my.data.image.full_path;
            } else {
              $this.$message("上传失败");
            }
          });
        } else {
          e.target.value = null;
          $this.$message("请上传符合条件的图片");
        }
      };
    },
    removes(e) {
      let url = this.api.deltheact,
        data = new FormData(),
        params = {};
      params = this.defaultData;
      params.activity_id = e.activity_id;
      for (let i in params) {
        data.append(i, params[i]);
      }
      this.$confirm("是否确定删除？", "提示", {
        confirmButtonText: "确定",
        cancelButtonText: "取消"
      })
        .then(() => {
          this.$http.post(url, data).then(res => {
            let my = res.data;
            if (my.status == 1) {
              this.$message({
                type: "success",
                message: "删除成功!"
              });
              this.getlist();
            } else {
              this.$message(my.data);
            }
          });
        })
        .catch(() => {
          this.$message({
            type: "info",
            message: "已取消删除"
          });
        });
    },
    dets(e) {
      this.det_data = e;
      this.detailvisible = true;
      console.log(e);
    },
    toeditor(e) {
      let a_time = [],
        e_time = [];
      a_time.push(e.activity_start, e.activity_end);
      e_time.push(e.push_start, e.push_end);
      this.fixcolumn = true;
      this.editnews = e.activity_content;
      this.editor.activity_title = e.activity_title;
      this.editor.activity_type = e.activity_type;
      this.editor.push_sex = e.push_sex;
      this.edt_pushimg = e.push_ad_pic;
      this.editor.push_ad_pic = e.push_ad_pic;
      this.editor.push_frequency = e.push_frequency;
      this.activity_id = e.activity_id;
      this.editor.push_model_id = e.push_model_id.split(",");
      this.det_act_time = a_time;
      this.det_put_time = e_time;
    },
    edtimg(e) {
      let name = e.target.files[0],
        src = window.URL.createObjectURL(name),
        url = this.api.uptoimg,
        params = {};
      params = this.defaultData;
      params.image = name;
      this.edt_pushimg = src;
      let datas = new FormData();
      for (let i in params) {
        datas.append(i, params[i]);
      }
      this.$http.post(url, datas).then(res => {
        let my = res.data;
        if (my.status == 1) {
          this.editor.push_ad_pic = my.data.image.full_path;
        }
      });
    },
    sureeditore() {
      let url = this.api.toaddnewact,
        params = {},
        act_time = this.det_act_time,
        data = new FormData(),
        put_time = this.det_put_time,
        agaedit = this.editnews,
        par = this.editor;
      params = this.defaultData;
      params.action = "modify";
      for (let i in par) {
        if (i != "push_model_id") {
          params[`info[${i}]`] = par[i];
        } else {
          params["info[push_model_id]"] = par.push_model_id.join(",");
        }
      }
      params["info[activity_start]"] = act_time[0];
      params["info[activity_end]"] = act_time[1];
      params["info[push_start]"] = put_time[0];
      params["info[push_end]"] = put_time[1];
      params["info[push_ad_pic]"] = par.push_ad_pic;
      params.activity_id = this.activity_id;
      params["info[activity_content]"] = JSON.stringify(agaedit);
      // console.log(params)
      for (let i in params) {
        data.append(i, params[i]);
      }
      this.$http.post(url, data).then(res => {
        let my = res.data;
        if (my.status == 1) {
          this.$message({
            type: "success",
            message: "成功！"
          });
          window.location.reload();
          this.fixcolumn = false;
        } else {
          this.$message("失败");
        }
      });
    }
  }
};
</script>

<style lang='scss' scoped>
.el-input {
  width: auto;
}
.tip_label {
  font-size: 14px;
  margin: 0 10px;
}
.form_tip {
  color: #ccc;
  line-height: 17px;
}
.rules {
  margin-right: 15px;
}
.cont_div,
.oth_cont_div {
  margin-bottom: 12px;
  display: flex;
  align-items: flex-start;
  .int_span {
    display: flex;
    flex-direction: column;
  }
  img {
    margin: 0 20px;
    width: 60px;
    cursor: pointer;
  }
}
.paginations {
  text-align: center;
  margin: 15px 0;
}
div.other_div {
  text-align: left;
  margin: 18px 0;
  span {
    display: inline-block;
    margin: 0 12px;
    text-overflow: ellipsis;
    overflow: hidden;
  }
  img {
    width: 100px;
    vertical-align: middle;
    cursor: pointer;
  }
  div {
    display: flex;
    margin: 10px 70px;
  }
}
</style>
